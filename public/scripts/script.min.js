/* grade-book 2014-04-25*/
function gradeBook(a,b,c){function d(a,b){this.title=a,this.code=b,this.id=f("course"),this.target=-1,this.currentGrade=-1,this.totalGrade=-1,this.assessments=[],this.assessmentMap={}}function e(a,b,c,d){this.title=a,this.weight=b,this.result=c,this.total=d,this.id=f("assessment")}function f(a){return"course"===a?"_c"+Math.random().toString(36).substr(2,9):"_a"+Math.random().toString(36).substr(2,9)}function g(a){if(!(a>=50))return"below-50";var b=85;do{if(a>=b)return"above-"+b;b-=5}while(b>=50)}a(function(){function f(a){a.css({opacity:0,height:"0%"}),a.css("opacity"),a.css("height"),a.css({opacity:1,height:"100%"})}function j(a){for(var b=0,c=a.length;c>b;b++)a[b].val("")}function k(){O.addClass("fade-out"),O.one(h,l),localStorage.setItem("showSplash","false")}function l(){O.addClass("hidden"),N.removeClass("hidden").addClass("fade-in")}function m(){var a=new d("","");I&&E(a.id,a),o(a)}function n(a){var b=JSON.parse(localStorage.getItem(a)),c={};b.__proto__=d.prototype,b.restoreAssessments(),c=o(b);for(var e=0,f=b.assessments.length;f>e;e++){var g=b.assessmentMap[b.assessments[e]],h=u(g);c.find(".assessments-container").append(h)}}function o(b){var c=a(i),d=""===b.title?"Untitled Course":b.title,e=""===b.code?"Course Code":b.code;return-1===K.indexOf(b.id)&&K.push(b.id),I&&E("courseCollection",K),L[b.id]=b,P.before(c),c.attr("data-cid",b.id),c.find("span.course-title").text(d),c.find("span.course-code").text(e),B(b),f(c),c}function p(){var b=a(this),c=b.parents(".course-item-container"),d=c.attr("data-cid");Q.addClass("modal-show"),Q.find("#save-assessment").attr("data-cid",d)}function q(){var b=a(this),c=b.parents(".course-item-container"),d=c.attr("data-cid"),e=b.attr("data-aid"),f=L[d],g=f.assessmentMap[e];R.addClass("modal-show"),R.find("#update-assessment, #delete-assessment").attr("data-aid",e),R.find("#update-assessment, #delete-assessment").attr("data-cid",d),Y.val(g.title),Z.val(g.weight),$.val(g.result),_.val(g.total),Y.attr("placeholder",g.title),Z.attr("placeholder",g.weight),$.attr("placeholder",g.result),_.attr("placeholder",g.total)}function r(){var b=a(this),c=b.attr("data-aid"),d=b.attr("data-cid"),e=a(".assessment-item[data-aid='"+c+"']"),f=L[d],g=f.assessmentMap[c],h="";g.title=Y.val(),g.weight=parseFloat(Z.val()),g.result=parseFloat($.val()),g.total=parseFloat(_.val()),f.assessmentMap[c]=g,f.calculateGrades(),I&&E(d,f),B(f),h=u(g);var i=e.prev();if(0===i.length){var j=e.next();0===j.length?(e.parent().append(h),e.remove()):(j.before(h),e.remove())}else i.after(h),e.remove();R.removeClass("modal-show")}function s(){{var b=a(this),c=b.attr("data-aid"),d=b.attr("data-cid"),e=a(".assessment-item[data-aid='"+c+"']"),f=L[d];f.assessmentMap[c]}e.remove(),f.deleteAssessment(c),f.calculateGrades(),B(f),I&&E(d,f),R.removeClass("modal-show")}function t(){var b=U.val(),c=parseFloat(V.val()),d=parseFloat(W.val()),f=parseFloat(X.val());if(isNaN(c)||isNaN(d)||isNaN(f)||d>f)return alert("Entered incorrect values"),!1;b=b.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");var g=a(this).attr("data-cid"),h=L[g],i=new e(b,c,d,f);h.insertAssessment(i),I&&E(g,h),B(h),a(".course-item-container[data-cid='"+g+"']").find(".assessments-container").append(u(i)),j([U,V,W,X]),Q.removeClass("modal-show")}function u(a){var b="";return b+="<div class='assessment-item' data-aid='"+a.id+"'>",b+="<div class='title'>"+a.title+"</div>",b+="<div class='mark'>"+a.getResult().toFixed(2)+"</div>",b+="<div class='weight'>"+a.weight+"%</div></div>"}function v(){var b=a(this),c=b.parents(".course-item-container").attr("data-cid"),d=L[c];T.attr("data-cid",c),T.find("span.course-title").text(d.title),T.find("span.current-grade").text(d.currentGrade.toFixed()),T.find("span.highest-mark").text(d.getHighestAssessment().getResult().toFixed()),T.find("span.highest-assessment-title").text(d.getHighestAssessment().title),T.find("span.lowest-mark").text(d.getLowestAssessment().getResult().toFixed()),T.find("span.lowest-assessment-title").text(d.getLowestAssessment().title),d.target>-1?(T.find("input#target-grade").val(d.target),a("input#target-grade").trigger("keyup")):(T.find("input#target-grade").val(""),T.find("p.proper-target").addClass("hidden"),T.find("p.no-target").removeClass("hidden")),T.addClass("modal-show")}function w(){var b=a(this),c=T.attr("data-cid"),d=L[c],e=b.val();if(e)if(T.find(".error-message").addClass("hidden"),e=parseFloat(e),0>e||e>100)T.find("p.proper-target").addClass("hidden"),T.find("p.invalid-target").removeClass("hidden");else{var f=100-d.getTotalWeight(),g=(e-d.totalGrade)/f*100;d.target=e,L[c]=d,I&&E(c,d),T.find("span.target-grade").text(e.toFixed()),T.find("span.remaining-average").text(g.toFixed()),T.find("p.proper-target").removeClass("hidden")}else T.find("p.proper-target").addClass("hidden"),T.find("p.no-target").removeClass("hidden")}function x(){var b=a(this),c=b.parents(".course-item-container").attr("data-cid");S.find("#delete-course").attr("data-cid",c),S.addClass("modal-show")}function y(){var b=a(this),c=b.attr("data-cid"),d=a(".course-item-container[data-cid='"+c+"']"),e=K.indexOf(c);K.splice(e,1),delete L[c],d.remove(),E("courseCollection",K),localStorage.removeItem(c),S.removeClass("modal-show")}function z(){a(".modal-window").removeClass("modal-show")}function A(b){var c=a(this),d=c.text(),e=c.attr("class").split(" ")[0];if((13===b.keyCode||9===b.keyCode)&&(c.trigger("blur"),c.html(d),I)){var f=c.parents(".course-item-container").attr("data-cid"),g=JSON.parse(localStorage.getItem(f)),h=e.split("-")[1];g[h]=c.text(),L[h]=g,E(f,g)}H&&clearTimeout(H),H=setTimeout(function(){if(I){var a=c.parents(".course-item-container").attr("data-cid"),b=JSON.parse(localStorage.getItem(a)),d=e.split("-")[1];b[d]=c.text(),L[d]=b,E(a,b)}},350)}function B(a){var b=M.find(".course-item-container[data-cid='"+a.id+"']"),c=b.find(".grade-container"),d=c.find("span.grade"),e=g(a.currentGrade),f=c.attr("class"),h=a.currentGrade;f=f.split(" ")[0],c.attr("class",f),-1===h||isNaN(h)||null===h?d.text("--%"):(d.text(parseFloat(a.currentGrade).toFixed(2)+"%"),c.addClass(e))}function C(){a(this).hasClass("first-time")?(a(this).text(""),a(this).removeClass("first-time")):a(this).selectText(),a(this).addClass("editing")}function D(){var b=a(this),c=b.attr("class").split(" ")[0];if(b.removeClass("editing"),I){var d=b.parents(".course-item-container").attr("data-cid"),e=JSON.parse(localStorage.getItem(d)),f=c.split("-")[1];e[f]=b.text(),L[f]=e,E(d,e)}}function E(a,b){"string"==typeof b?localStorage.setItem(a,b):"object"==typeof b&&localStorage.setItem(a,JSON.stringify(b)),console.log("Saving "+a+"...")}function F(){if(localStorage.getItem("courseCollection")){K=JSON.parse(localStorage.getItem("courseCollection"));for(var a=0,b=K.length;b>a;a++)n(K[a])}else K=[],E("courseCollection",K)}function G(){if(I){if(localStorage.getItem("version")<1){for(item in localStorage)delete localStorage[item];localStorage.setItem("version",1)}else F();localStorage.getItem("showSplash")&&(J=!1)}J?O.removeClass("hidden"):l()}var H,I=!1,J=!0,K=[],L={},M=(a(c),a("body")),N=a("#wrapper"),O=a("#splash-page"),P=a("#add-course-item"),Q=a("#add-assessment-modal"),R=a("#edit-assessment-modal"),S=a("#delete-course-modal"),T=a("#course-summary"),U=Q.find("input#assessment-title"),V=Q.find("input#assessment-weight"),W=Q.find("input#assessment-result"),X=Q.find("input#assessment-result-total"),Y=R.find("input#assessment-title"),Z=R.find("input#assessment-weight"),$=R.find("input#assessment-result"),_=R.find("input#assessment-result-total");if(a.fn.selectText=function(){var a=c,d=this[0];if(a.body.createTextRange){var e=c.body.createTextRange();e.moveToElementText(d),e.select()}else if(b.getSelection){var f=b.getSelection(),e=c.createRange();e.selectNodeContents(d),f.removeAllRanges(),f.addRange(e)}},M.on("click","#start-now",k).on("click","#add-course-item",m).on("click",".add-assessment",p).on("click",".assessment-item",q).on("click","#modal-close, .modal-overlay",z).on("click",".delete-course",x).on("click",".course-summary, .grade-container",v),Q.on("click","#save-assessment",t),R.on("click","#update-assessment",r),R.on("click","#delete-assessment",s),S.on("click","#delete-course",y),T.on("keyup","input#target-grade",w),M.on("keyup",".contenteditable",A).on("click",".contenteditable",C).on("blur",".contenteditable",D),b.localStorage)I=!0,G();else{var ab=a("#no-autosave");ab.addClass("modal-show"),ab.on("click","#continue",function(){ab.removeClass("modal-show"),G()})}});var h="webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",i="<div class='course-item-container' data-cid='-1'><div class='course-item'><div class='content-container'><div class='course-title-container'><span class='course-title first-time contenteditable' contenteditable='true'>[Course Title]</span></div><div class='course-code-container'><span class='course-code first-time contenteditable' contenteditable='true'>[Course Code]</span></div><div class='button-group'><span class='add-assessment button button-charcoal'><i class='fa fa-plus-circle'></i> New Assessment</span> <span class='course-summary button button-charcoal'><i class='fa fa-bar-chart-o'></i> Course Summary</span> <span class='delete-course button button-red' title='Delete Course'><i class='fa fa-trash-o fa-lg'></i></span></div><div class='assessments-container clearfix'></div></div><div class='grade-container'><span class='grade'>--%</span></div></div>";d.prototype.restoreAssessments=function(){for(var a=0,b=this.assessments.length;b>a;a++)this.assessmentMap[this.assessments[a]].__proto__=e.prototype},d.prototype.insertAssessment=function(a){this.assessments.push(a.id),this.assessmentMap[a.id]=a,this.calculateGrades()},d.prototype.deleteAssessment=function(a){var b=this.assessments.indexOf(a);this.assessments.splice(b,1),delete this.assessmentMap[a]},d.prototype.calculateGrades=function(){for(var a=0,b=0,c=0,d=this.assessments.length;d>c;c++){var e=this.assessmentMap[this.assessments[c]];a+=e.getWeightedResult(),b+=e.weight}this.totalGrade=a,this.currentGrade=a/b*100},d.prototype.getTotalWeight=function(){for(var a=0,b=0,c=this.assessments.length;c>b;b++){var d=this.assessmentMap[this.assessments[b]];a+=d.weight}return a},d.prototype.getHighestAssessment=function(){for(var a=-1,b=-1,c=0,d=this.assessments.length;d>c;c++){var e=this.assessmentMap[this.assessments[c]];e.getResult()>a&&(b=c,a=e.getResult())}return this.assessmentMap[this.assessments[b]]},d.prototype.getLowestAssessment=function(){for(var a=999999,b=-1,c=0,d=this.assessments.length;d>c;c++){var e=this.assessmentMap[this.assessments[c]];e.getResult()<a&&(b=c,a=e.getResult())}return this.assessmentMap[this.assessments[b]]},e.prototype.getResult=function(){return this.result/this.total*100},e.prototype.getWeightedResult=function(){return this.result/this.total*this.weight}}!function(a){a(window.jQuery,window,document)}(gradeBook);