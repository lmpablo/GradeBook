/* grade-book 2014-04-25*/
function gradeBook(a,b,c){function d(a,b){this.title=a,this.code=b,this.id=f("course"),this.target=-1,this.currentGrade=-1,this.totalGrade=-1,this.assessments=[],this.assessmentMap={}}function e(a,b,c,d){this.title=a,this.weight=b,this.result=c,this.total=d,this.id=f("assessment")}function f(a){return"course"===a?"_c"+Math.random().toString(36).substr(2,9):"_a"+Math.random().toString(36).substr(2,9)}function g(a){if(!(a>=50))return"below-50";var b=85;do{if(a>=b)return"above-"+b;b-=5}while(b>=50)}a(function(){function f(a){a.css({opacity:0,height:"0%"}),a.css("opacity"),a.css("height"),a.css({opacity:1,height:"100%"})}function j(a){for(var b=0,c=a.length;c>b;b++)a[b].val("")}function k(){L.addClass("fade-out"),L.one(h,l),localStorage.setItem("showSplash","false")}function l(){L.addClass("hidden"),K.removeClass("hidden").addClass("fade-in")}function m(){var a=new d("","");F&&B(a.id,a),o(a)}function n(a){var b=JSON.parse(localStorage.getItem(a)),c={};b.__proto__=d.prototype,b.restoreAssessments(),c=o(b);for(var e=0,f=b.assessments.length;f>e;e++){var g=b.assessmentMap[b.assessments[e]],h=t(g);c.find(".assessments-container").append(h)}}function o(b){var c=a(i),d=""===b.title?"[Course Title]":b.title,e=""===b.code?"[Course Code]":b.code;return-1===H.indexOf(b.id)&&H.push(b.id),F&&B("courseCollection",H),I[b.id]=b,M.before(c),c.attr("data-cid",b.id),c.find("span.course-title").text(d),c.find("span.course-code").text(e),y(b),f(c),c}function p(){var b=a(this),c=b.parents(".course-item-container"),d=c.attr("data-cid");N.addClass("modal-show"),N.find("#save-assessment").attr("data-cid",d)}function q(){var b=a(this),c=b.parents(".course-item-container"),d=c.attr("data-cid"),e=b.attr("data-aid"),f=I[d],g=f.assessmentMap[e];O.addClass("modal-show"),O.find("#update-assessment, #delete-assessment").attr("data-aid",e),O.find("#update-assessment, #delete-assessment").attr("data-cid",d),U.val(g.title),V.val(g.weight),W.val(g.result),X.val(g.total),U.attr("placeholder",g.title),V.attr("placeholder",g.weight),W.attr("placeholder",g.result),X.attr("placeholder",g.total)}function r(){var b=a(this),c=b.attr("data-aid"),d=b.attr("data-cid"),e=a(".assessment-item[data-aid='"+c+"']"),f=I[d],g=f.assessmentMap[c],h="";g.title=U.val(),g.weight=parseFloat(V.val()),g.result=parseFloat(W.val()),g.total=parseFloat(X.val()),f.assessmentMap[c]=g,f.calculateGrades(),F&&B(d,f),y(f),h=t(g);var i=e.prev();if(0===i.length){var j=e.next();0===j.length?(e.parent().append(h),e.remove()):(j.before(h),e.remove())}else i.after(h),e.remove();O.removeClass("modal-show")}function s(){var b=Q.val(),c=parseFloat(R.val()),d=parseFloat(S.val()),f=parseFloat(T.val());if(isNaN(c)||isNaN(d)||isNaN(f)||d>f)return alert("Entered incorrect values"),!1;b=b.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");var g=a(this).attr("data-cid"),h=I[g],i=new e(b,c,d,f);h.insertAssessment(i),localStorage.setItem(g,JSON.stringify(h)),y(h),a(".course-item-container[data-cid='"+g+"']").find(".assessments-container").append(t(i)),j([Q,R,S,T]),N.removeClass("modal-show")}function t(a){var b="";return b+="<div class='assessment-item' data-aid='"+a.id+"'>",b+="<div class='title'>"+a.title+"</div>",b+="<div class='mark'>"+a.getResult().toFixed(2)+"</div>",b+="<div class='weight'>"+a.weight+"%</div></div>"}function u(){var b=a(this),c=b.parents(".course-item-container").attr("data-cid"),d=I[c];P.attr("data-cid",c),P.find("span.course-title").text(d.title),P.find("span.current-grade").text(d.currentGrade.toFixed()),P.find("span.highest-mark").text(d.getHighestAssessment().getResult().toFixed()),P.find("span.highest-assessment-title").text(d.getHighestAssessment().title),P.find("span.lowest-mark").text(d.getLowestAssessment().getResult().toFixed()),P.find("span.lowest-assessment-title").text(d.getLowestAssessment().title),d.target>-1?(P.find("input#target-grade").val(d.target),a("input#target-grade").trigger("keyup")):(P.find("input#target-grade").val(""),P.find("p.proper-target").addClass("hidden"),P.find("p.no-target").removeClass("hidden")),P.addClass("modal-show")}function v(){var b=a(this),c=P.attr("data-cid"),d=I[c],e=b.val();if(e)if(P.find(".error-message").addClass("hidden"),e=parseFloat(e),0>e||e>100)P.find("p.proper-target").addClass("hidden"),P.find("p.invalid-target").removeClass("hidden");else{var f=100-d.getTotalWeight(),g=(e-d.totalGrade)/f*100;d.target=e,I[c]=d,F&&B(c,d),P.find("span.target-grade").text(e.toFixed()),P.find("span.remaining-average").text(g.toFixed()),P.find("p.proper-target").removeClass("hidden")}else P.find("p.proper-target").addClass("hidden"),P.find("p.no-target").removeClass("hidden")}function w(){a(".modal-window").removeClass("modal-show")}function x(b){var c=a(this),d=c.text(),e=c.attr("class").split(" ")[0];if((13===b.keyCode||9===b.keyCode)&&(c.trigger("blur"),c.html(d),F)){var f=c.parents(".course-item-container").attr("data-cid"),g=JSON.parse(localStorage.getItem(f)),h=e.split("-")[1];g[h]=c.text(),I[h]=g,B(f,g)}E&&clearTimeout(E),E=setTimeout(function(){if(F){var a=c.parents(".course-item-container").attr("data-cid"),b=JSON.parse(localStorage.getItem(a)),d=e.split("-")[1];b[d]=c.text(),I[d]=b,B(a,b)}},350)}function y(a){var b=J.find(".course-item-container[data-cid='"+a.id+"']"),c=b.find(".grade-container"),d=c.find("span.grade"),e=g(a.currentGrade),f=c.attr("class"),h=a.currentGrade;f=f.split(" ")[0],-1===h?d.text("--%"):(d.text(parseFloat(a.currentGrade).toFixed(2)+"%"),c.attr("class",f),c.addClass(e))}function z(){a(this).hasClass("first-time")?(a(this).text(""),a(this).removeClass("first-time")):a(this).selectText(),a(this).addClass("editing")}function A(){var b=a(this),c=b.attr("class").split(" ")[0];if(b.removeClass("editing"),F){var d=b.parents(".course-item-container").attr("data-cid"),e=JSON.parse(localStorage.getItem(d)),f=c.split("-")[1];e[f]=b.text(),I[f]=e,B(d,e)}}function B(a,b){"string"==typeof b?localStorage.setItem(a,b):"object"==typeof b&&localStorage.setItem(a,JSON.stringify(b)),console.log("Saving "+a+"...")}function C(){if(localStorage.getItem("courseCollection")){H=JSON.parse(localStorage.getItem("courseCollection"));for(var a=0,b=H.length;b>a;a++)n(H[a])}else H=[],B("courseCollection",H)}function D(){if(F){if(localStorage.getItem("version")<1){for(item in localStorage)delete localStorage[item];localStorage.setItem("version",1)}else C();localStorage.getItem("showSplash")&&(G=!1)}G?L.removeClass("hidden"):l()}var E,F=!1,G=!0,H=[],I={},J=(a(c),a("body")),K=a("#wrapper"),L=a("#splash-page"),M=a("#add-course-item"),N=a("#add-assessment-modal"),O=a("#edit-assessment-modal"),P=a("#course-summary"),Q=N.find("input#assessment-title"),R=N.find("input#assessment-weight"),S=N.find("input#assessment-result"),T=N.find("input#assessment-result-total"),U=O.find("input#assessment-title"),V=O.find("input#assessment-weight"),W=O.find("input#assessment-result"),X=O.find("input#assessment-result-total");if(a.fn.selectText=function(){var a=c,d=this[0];if(a.body.createTextRange){var e=c.body.createTextRange();e.moveToElementText(d),e.select()}else if(b.getSelection){var f=b.getSelection(),e=c.createRange();e.selectNodeContents(d),f.removeAllRanges(),f.addRange(e)}},J.on("click","#start-now",k).on("click","#add-course-item",m).on("click",".add-assessment",p).on("click",".assessment-item",q).on("click","#modal-close, .modal-overlay",w).on("click",".course-summary, .grade-container",u),N.on("click","#save-assessment",s),O.on("click","#update-assessment",r),P.on("keyup","input#target-grade",v),J.on("keyup",".contenteditable",x).on("click",".contenteditable",z).on("blur",".contenteditable",A),b.localStorage)F=!0,D();else{var Y=a("#no-autosave");Y.addClass("modal-show"),Y.on("click","#continue",function(){Y.removeClass("modal-show"),D()})}});var h="webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",i="<div class='course-item-container' data-cid='-1'><div class='course-item'><div class='content-container'><div class='course-title-container'><span class='course-title first-time contenteditable' contenteditable='true'>[Course Title]</span></div><div class='course-code-container'><span class='course-code first-time contenteditable' contenteditable='true'>[Course Code]</span></div><div class='button-group'><span class='add-assessment button button-charcoal'><i class='fa fa-plus-circle'></i> New Assessment</span> <span class='course-summary button button-charcoal'><i class='fa fa-bar-chart-o'></i> Course Summary</span></div><div class='assessments-container clearfix'></div></div><div class='grade-container'><span class='grade'>--%</span></div></div>";d.prototype.restoreAssessments=function(){for(var a=0,b=this.assessments.length;b>a;a++)this.assessmentMap[this.assessments[a]].__proto__=e.prototype},d.prototype.insertAssessment=function(a){this.assessments.push(a.id),this.assessmentMap[a.id]=a,this.calculateGrades()},d.prototype.calculateGrades=function(){for(var a=0,b=0,c=0,d=this.assessments.length;d>c;c++){var e=this.assessmentMap[this.assessments[c]];a+=e.getWeightedResult(),b+=e.weight}console.log("resultSum "+a+" ; totalSum "+b),this.totalGrade=a,this.currentGrade=a/b*100},d.prototype.getTotalWeight=function(){for(var a=0,b=0,c=this.assessments.length;c>b;b++){var d=this.assessmentMap[this.assessments[b]];a+=d.weight}return a},d.prototype.getHighestAssessment=function(){for(var a=-1,b=-1,c=0,d=this.assessments.length;d>c;c++){var e=this.assessmentMap[this.assessments[c]];e.getResult()>a&&(b=c,a=e.getResult())}return this.assessmentMap[this.assessments[b]]},d.prototype.getLowestAssessment=function(){for(var a=999999,b=-1,c=0,d=this.assessments.length;d>c;c++){var e=this.assessmentMap[this.assessments[c]];e.getResult()<a&&(b=c,a=e.getResult())}return this.assessmentMap[this.assessments[b]]},e.prototype.getResult=function(){return this.result/this.total*100},e.prototype.getWeightedResult=function(){return this.result/this.total*this.weight}}!function(a){a(window.jQuery,window,document)}(gradeBook);