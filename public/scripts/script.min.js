/* grade-book 2014-04-25*/
function gradeBook(a,b,c){function d(a,b){this.title=a,this.code=b,this.id=f("course"),this.target=-1,this.currentGrade=-1,this.totalGrade=-1,this.assessments=[],this.assessmentMap={}}function e(a,b,c,d){this.title=a,this.weight=b,this.result=c,this.total=d,this.id=f("assessment")}function f(a){return"course"===a?"_c"+Math.random().toString(36).substr(2,9):"_a"+Math.random().toString(36).substr(2,9)}function g(a){if(!(a>=50))return"below-50";var b=85;do{if(a>=b)return"above-"+b;b-=5}while(b>=50)}a(function(){function f(a){a.css({opacity:0,height:"0%"}),a.css("opacity"),a.css("height"),a.css({opacity:1,height:"100%"})}function j(a){for(var b=0,c=a.length;c>b;b++)a[b].val("")}function k(){M.addClass("fade-out"),M.one(h,l),localStorage.setItem("showSplash","false")}function l(){M.addClass("hidden"),L.removeClass("hidden").addClass("fade-in")}function m(){var a=new d("","");G&&C(a.id,a),o(a)}function n(a){var b=JSON.parse(localStorage.getItem(a)),c={};b.__proto__=d.prototype,b.restoreAssessments(),c=o(b);for(var e=0,f=b.assessments.length;f>e;e++){var g=b.assessmentMap[b.assessments[e]],h=u(g);c.find(".assessments-container").append(h)}}function o(b){var c=a(i),d=""===b.title?"Untitled Course":b.title,e=""===b.code?"Course Code":b.code;return-1===I.indexOf(b.id)&&I.push(b.id),G&&C("courseCollection",I),J[b.id]=b,N.before(c),c.attr("data-cid",b.id),c.find("span.course-title").text(d),c.find("span.course-code").text(e),z(b),f(c),c}function p(){var b=a(this),c=b.parents(".course-item-container"),d=c.attr("data-cid");O.addClass("modal-show"),O.find("#save-assessment").attr("data-cid",d)}function q(){var b=a(this),c=b.parents(".course-item-container"),d=c.attr("data-cid"),e=b.attr("data-aid"),f=J[d],g=f.assessmentMap[e];P.addClass("modal-show"),P.find("#update-assessment, #delete-assessment").attr("data-aid",e),P.find("#update-assessment, #delete-assessment").attr("data-cid",d),V.val(g.title),W.val(g.weight),X.val(g.result),Y.val(g.total),V.attr("placeholder",g.title),W.attr("placeholder",g.weight),X.attr("placeholder",g.result),Y.attr("placeholder",g.total)}function r(){var b=a(this),c=b.attr("data-aid"),d=b.attr("data-cid"),e=a(".assessment-item[data-aid='"+c+"']"),f=J[d],g=f.assessmentMap[c],h="";g.title=V.val(),g.weight=parseFloat(W.val()),g.result=parseFloat(X.val()),g.total=parseFloat(Y.val()),f.assessmentMap[c]=g,f.calculateGrades(),G&&C(d,f),z(f),h=u(g);var i=e.prev();if(0===i.length){var j=e.next();0===j.length?(e.parent().append(h),e.remove()):(j.before(h),e.remove())}else i.after(h),e.remove();P.removeClass("modal-show")}function s(){{var b=a(this),c=b.attr("data-aid"),d=b.attr("data-cid"),e=a(".assessment-item[data-aid='"+c+"']"),f=J[d];f.assessmentMap[c]}e.remove(),f.deleteAssessment(c),f.calculateGrades(),z(f),G&&C(d,f),P.removeClass("modal-show")}function t(){var b=R.val(),c=parseFloat(S.val()),d=parseFloat(T.val()),f=parseFloat(U.val());if(isNaN(c)||isNaN(d)||isNaN(f)||d>f)return alert("Entered incorrect values"),!1;b=b.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");var g=a(this).attr("data-cid"),h=J[g],i=new e(b,c,d,f);h.insertAssessment(i),G&&C(g,h),z(h),a(".course-item-container[data-cid='"+g+"']").find(".assessments-container").append(u(i)),j([R,S,T,U]),O.removeClass("modal-show")}function u(a){var b="";return b+="<div class='assessment-item' data-aid='"+a.id+"'>",b+="<div class='title'>"+a.title+"</div>",b+="<div class='mark'>"+a.getResult().toFixed(2)+"</div>",b+="<div class='weight'>"+a.weight+"%</div></div>"}function v(){var b=a(this),c=b.parents(".course-item-container").attr("data-cid"),d=J[c];Q.attr("data-cid",c),Q.find("span.course-title").text(d.title),Q.find("span.current-grade").text(d.currentGrade.toFixed()),Q.find("span.highest-mark").text(d.getHighestAssessment().getResult().toFixed()),Q.find("span.highest-assessment-title").text(d.getHighestAssessment().title),Q.find("span.lowest-mark").text(d.getLowestAssessment().getResult().toFixed()),Q.find("span.lowest-assessment-title").text(d.getLowestAssessment().title),d.target>-1?(Q.find("input#target-grade").val(d.target),a("input#target-grade").trigger("keyup")):(Q.find("input#target-grade").val(""),Q.find("p.proper-target").addClass("hidden"),Q.find("p.no-target").removeClass("hidden")),Q.addClass("modal-show")}function w(){var b=a(this),c=Q.attr("data-cid"),d=J[c],e=b.val();if(e)if(Q.find(".error-message").addClass("hidden"),e=parseFloat(e),0>e||e>100)Q.find("p.proper-target").addClass("hidden"),Q.find("p.invalid-target").removeClass("hidden");else{var f=100-d.getTotalWeight(),g=(e-d.totalGrade)/f*100;d.target=e,J[c]=d,G&&C(c,d),Q.find("span.target-grade").text(e.toFixed()),Q.find("span.remaining-average").text(g.toFixed()),Q.find("p.proper-target").removeClass("hidden")}else Q.find("p.proper-target").addClass("hidden"),Q.find("p.no-target").removeClass("hidden")}function x(){a(".modal-window").removeClass("modal-show")}function y(b){var c=a(this),d=c.text(),e=c.attr("class").split(" ")[0];if((13===b.keyCode||9===b.keyCode)&&(c.trigger("blur"),c.html(d),G)){var f=c.parents(".course-item-container").attr("data-cid"),g=JSON.parse(localStorage.getItem(f)),h=e.split("-")[1];g[h]=c.text(),J[h]=g,C(f,g)}F&&clearTimeout(F),F=setTimeout(function(){if(G){var a=c.parents(".course-item-container").attr("data-cid"),b=JSON.parse(localStorage.getItem(a)),d=e.split("-")[1];b[d]=c.text(),J[d]=b,C(a,b)}},350)}function z(a){var b=K.find(".course-item-container[data-cid='"+a.id+"']"),c=b.find(".grade-container"),d=c.find("span.grade"),e=g(a.currentGrade),f=c.attr("class"),h=a.currentGrade;f=f.split(" ")[0],c.attr("class",f),-1===h||isNaN(h)||null===h?d.text("--%"):(d.text(parseFloat(a.currentGrade).toFixed(2)+"%"),c.addClass(e))}function A(){a(this).hasClass("first-time")?(a(this).text(""),a(this).removeClass("first-time")):a(this).selectText(),a(this).addClass("editing")}function B(){var b=a(this),c=b.attr("class").split(" ")[0];if(b.removeClass("editing"),G){var d=b.parents(".course-item-container").attr("data-cid"),e=JSON.parse(localStorage.getItem(d)),f=c.split("-")[1];e[f]=b.text(),J[f]=e,C(d,e)}}function C(a,b){"string"==typeof b?localStorage.setItem(a,b):"object"==typeof b&&localStorage.setItem(a,JSON.stringify(b)),console.log("Saving "+a+"...")}function D(){if(localStorage.getItem("courseCollection")){I=JSON.parse(localStorage.getItem("courseCollection"));for(var a=0,b=I.length;b>a;a++)n(I[a])}else I=[],C("courseCollection",I)}function E(){if(G){if(localStorage.getItem("version")<1){for(item in localStorage)delete localStorage[item];localStorage.setItem("version",1)}else D();localStorage.getItem("showSplash")&&(H=!1)}H?M.removeClass("hidden"):l()}var F,G=!1,H=!0,I=[],J={},K=(a(c),a("body")),L=a("#wrapper"),M=a("#splash-page"),N=a("#add-course-item"),O=a("#add-assessment-modal"),P=a("#edit-assessment-modal"),Q=a("#course-summary"),R=O.find("input#assessment-title"),S=O.find("input#assessment-weight"),T=O.find("input#assessment-result"),U=O.find("input#assessment-result-total"),V=P.find("input#assessment-title"),W=P.find("input#assessment-weight"),X=P.find("input#assessment-result"),Y=P.find("input#assessment-result-total");if(a.fn.selectText=function(){var a=c,d=this[0];if(a.body.createTextRange){var e=c.body.createTextRange();e.moveToElementText(d),e.select()}else if(b.getSelection){var f=b.getSelection(),e=c.createRange();e.selectNodeContents(d),f.removeAllRanges(),f.addRange(e)}},K.on("click","#start-now",k).on("click","#add-course-item",m).on("click",".add-assessment",p).on("click",".assessment-item",q).on("click","#modal-close, .modal-overlay",x).on("click",".course-summary, .grade-container",v),O.on("click","#save-assessment",t),P.on("click","#update-assessment",r),P.on("click","#delete-assessment",s),Q.on("keyup","input#target-grade",w),K.on("keyup",".contenteditable",y).on("click",".contenteditable",A).on("blur",".contenteditable",B),b.localStorage)G=!0,E();else{var Z=a("#no-autosave");Z.addClass("modal-show"),Z.on("click","#continue",function(){Z.removeClass("modal-show"),E()})}});var h="webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",i="<div class='course-item-container' data-cid='-1'><div class='course-item'><div class='content-container'><div class='course-title-container'><span class='course-title first-time contenteditable' contenteditable='true'>[Course Title]</span></div><div class='course-code-container'><span class='course-code first-time contenteditable' contenteditable='true'>[Course Code]</span></div><div class='button-group'><span class='add-assessment button button-charcoal'><i class='fa fa-plus-circle'></i> New Assessment</span> <span class='course-summary button button-charcoal'><i class='fa fa-bar-chart-o'></i> Course Summary</span></div><div class='assessments-container clearfix'></div></div><div class='grade-container'><span class='grade'>--%</span></div></div>";d.prototype.restoreAssessments=function(){for(var a=0,b=this.assessments.length;b>a;a++)this.assessmentMap[this.assessments[a]].__proto__=e.prototype},d.prototype.insertAssessment=function(a){this.assessments.push(a.id),this.assessmentMap[a.id]=a,this.calculateGrades()},d.prototype.deleteAssessment=function(a){var b=this.assessments.indexOf(a);this.assessments.splice(b,1),delete this.assessmentMap[a]},d.prototype.calculateGrades=function(){for(var a=0,b=0,c=0,d=this.assessments.length;d>c;c++){var e=this.assessmentMap[this.assessments[c]];a+=e.getWeightedResult(),b+=e.weight}this.totalGrade=a,this.currentGrade=a/b*100},d.prototype.getTotalWeight=function(){for(var a=0,b=0,c=this.assessments.length;c>b;b++){var d=this.assessmentMap[this.assessments[b]];a+=d.weight}return a},d.prototype.getHighestAssessment=function(){for(var a=-1,b=-1,c=0,d=this.assessments.length;d>c;c++){var e=this.assessmentMap[this.assessments[c]];e.getResult()>a&&(b=c,a=e.getResult())}return this.assessmentMap[this.assessments[b]]},d.prototype.getLowestAssessment=function(){for(var a=999999,b=-1,c=0,d=this.assessments.length;d>c;c++){var e=this.assessmentMap[this.assessments[c]];e.getResult()<a&&(b=c,a=e.getResult())}return this.assessmentMap[this.assessments[b]]},e.prototype.getResult=function(){return this.result/this.total*100},e.prototype.getWeightedResult=function(){return this.result/this.total*this.weight}}!function(a){a(window.jQuery,window,document)}(gradeBook);